# Maintainer: Boris HUISGEN <bhuisgen@hbis.fr>
pkgname=zabbix-server-pgsql
pkgver=3.2.1
pkgrel=0
pkgdesc="Zabbix Network Monitoring Server with PostgreSQL storage"
url="http://www.zabbix.com"
arch="all"
license="GPL"
depends="fping"
makedepends="autoconf automake mariadb-dev postgresql-dev sqlite-dev openjdk8
    curl-dev net-snmp-dev openipmi-dev openssl-dev unixodbc-dev
    libxml2-dev libssh2"
install="$pkgname.pre-install"
pkgusers="zabbix"
pkggroups="zabbix"
source="http://downloads.sourceforge.net/zabbix/zabbix-$pkgver.tar.gz
    zabbix-getloadavg.patch
    automake.patch
    musl-fix-includes.patch
    zabbix-server.initd
    zabbix-server.confd
    zabbix_server.conf.patch
    zabbix-add-custom-rootfs.patch
"

_builddir="$srcdir"/zabbix-$pkgver

# security fixes:
#   3.0.4-r0:
#   - CVE N/A ZBX-11023

prepare() {
    cd "$_builddir"
    # update_config_sub || return 1
    for i in $source; do
        case $i in
        *eglibc*.patch)
            if [ "$CLIBC" == "eglibc" ]; then
                msg "Applying $i"
                patch -p1 -i "$srcdir"/$i || return 1
            fi
            ;;
        *.patch)
            msg "Applying $i"
            patch -p1 -i "$srcdir"/$i || return 1
            ;;
        esac
    done
    aclocal -I m4 && autoconf && autoheader \
        && automake --add-missing || return 1
    # update_config_sub
    # Fix config file locations
    sed -i "$_builddir"/conf/zabbix_server.conf \
        -e 's|SNMPTrapperFile=/tmp|SNMPTrapperFile=/var/log/zabbix|' \
        -e 's|PidFile=/tmp|PidFile=/var/run/zabbix|' \
        -e 's|LogFile=/tmp|LogFile=/var/log/zabbix|' || return 1
}

build() {
    _configure="--prefix=/usr \
        --sysconfdir=/etc/zabbix \
        --mandir=/usr/share/man \
        --infodir=/usr/share/info \
        --enable-ipv6 \
        --with-net-snmp \
        --with-libcurl \
        --with-libxml2 \
        --with-openipmi \
        --with-unixodbc \
        --with-ssh2 \
        --with-openssl"

    cd "$_builddir"
    ./configure \
        --enable-server \
        --with-postgresql \
        --build=$CBUILD \
        --host=$CHOST \
        $_configure \
        || return 1
    make || return 1
}

package() {
    install -d -m0750 -o zabbix -g zabbix \
        "$pkgdir"/var/run/zabbix "$pkgdir"/var/log/zabbix
    install -D -m0644 "$_builddir"/conf/zabbix_server.conf \
        "$pkgdir"/etc/zabbix/zabbix_server.conf
    install -D -m0755 "$srcdir"/zabbix-server.initd \
        "$pkgdir"/etc/init.d/zabbix-server || return 1
    install -D -m0644 "$srcdir"/zabbix-server.confd \
        "$pkgdir"/etc/conf.d/zabbix-server || return 1
    mkdir -p "$pkgdir"/usr/sbin || return 1
    mv "$_builddir"/src/zabbix_server/zabbix_server \
        "$pkgdir"/usr/sbin/ || return 1
    mkdir -p "$pkgdir"/usr/share/zabbix/database || return 1
    mv "$_builddir"/database/postgresql \
        "$pkgdir"/usr/share/zabbix/database/ || return 1
    cd "$_builddir"
    for i in upgrades/dbpatches/*/postgresql; do
        [ -e $i ] || continue
        mkdir -p "$pkgdir"/usr/share/zabbix/${i%/*}
        mv "$i" "$pkgdir"/usr/share/zabbix/$i
    done
}

md5sums="4f363b923ef2b5eefddee8dfc5f51e2b  zabbix-3.2.1.tar.gz
3a71e310bd2b38498a7c6830169f7480  zabbix-getloadavg.patch
bf62c539870874e11de39c60cb974786  automake.patch
40c81bdec85815f4ba637eb6528cc5e8  musl-fix-includes.patch
f44105322022734dc42032db0396fe9e  zabbix-server.initd
bd91d0243cf8f72b86b9bf0b91963663  zabbix-server.confd
3d031903ea14e1de0804ff1230fd968e  zabbix_server.conf.patch
a4f210640376485c58dd6780f02ff79f  zabbix-add-custom-rootfs.patch"
sha256sums="8926b96ef05cba041d05329130f40e8e1311ad201e58c75d22005eda4075c091  zabbix-3.2.1.tar.gz
d2c0651c5fa67a1857707552e79ecece7ca95c149042460c40456634bf7611dc  zabbix-getloadavg.patch
b347ca77660e69bea353c50e2fce0c7c4cc837f782c9f84f74ba92c1a62b4c1b  automake.patch
38b4e1a5d5c16c7d9b31347acf710d84b693f6e1df365d1072548e897e034884  musl-fix-includes.patch
d4c6dcf9b78f78a2ef2b4a4f2763fb90f81d0298bc90bd164db8604f161182ec  zabbix-server.initd
ddf75041fb0afc5b211dd79a934341cc9db4325447ad33a42cbf09bdfb5cad42  zabbix-server.confd
f87b221d32b3088db78c013f11d035339d7058817092dfdcc39898b4b3ee8448  zabbix_server.conf.patch
ad9e4a9d113c03536ec5eefe6ae27c9f3fddc5a4736dbe8b58aafd8703785079  zabbix-add-custom-rootfs.patch"
sha512sums="85d43360c1cf4b5507d92a483a5e2a4283bea53e9b85f08c29ff36908ba43695a3ac89a69ca83f9f79f2a8336b96e1a1e9be6dc2f862e449006f8892e3c01961  zabbix-3.2.1.tar.gz
b65c6ba7701d98ae7f6fe2124c1d2b8b8fea3c3cc7ee080bf99f5afff0aaa6a025c2a1f5136b4700b53d1b7609e6185642650d7edd013c554b2af37fddae771c  zabbix-getloadavg.patch
9bff8966cb8b3f1767bfb1b3f3529bca5c9957f2c8179a40ded3b4e43615ba9fb408aef43092fd119b7df80b042555d05c9780fac3760176b95524aa48252fee  automake.patch
9b87ec1ea4a9cbb501c16012d498cdae82a696f4cd495e1e8cb201d9e31c6e135da5bb264c6273f2de87297bd3e4bd16f66703610686f5d610e3316ee24aac91  musl-fix-includes.patch
3a25bf9f428f55545dd735aea2855e0e4927e006ca01a2f918ec161ffe9b2ec66e46598bf34208e24535e1d04e33087f42eb8226b17eb4118abd6507bbb10ff5  zabbix-server.initd
a91821c6086a1fc0197750cc68073419defcb7d775b11b14a993409a8f61c7a1a0a0af95de27eed9f3b8357f8362640cb1b26b91b56f4f1d714ca6f222d02b80  zabbix-server.confd
e0c9f937d39e15fa34e70e8ae9e6578b221b51c13dc0515e807675d153a85ab6370ed20ce2d06aa4457baaf3963edce525cd00e85fb105b36b58741798d13836  zabbix_server.conf.patch
13f35f3fa8a71a3b32a3982f0cbbf2400bb61f249793afb1b113ba935a23946e66dbd201362ff4bada47dfe1e668ccd5317d102a6ebf45ead397ce3d246fcf66  zabbix-add-custom-rootfs.patch"
