# Maintainer: Boris HUISGEN <bhuisgen@hbis.fr>
pkgname=zabbix-server-sqlite3
pkgver=3.2.3
pkgrel=0
pkgdesc="Zabbix Network Monitoring Server with SQLite3 storage"
url="http://www.zabbix.com"
arch="all"
license="GPL"
depends="fping"
makedepends="autoconf automake curl-dev gnutls-dev libssh2 libxml2-dev
    mariadb-dev net-snmp-dev openipmi-dev openjdk8 postgresql-dev sqlite-dev
    unixodbc-dev"
install="$pkgname.pre-install"
pkgusers="zabbix"
pkggroups="zabbix"
source="http://downloads.sourceforge.net/zabbix/zabbix-$pkgver.tar.gz
    zabbix-getloadavg.patch
    automake.patch
    musl-fix-includes.patch
    zabbix-server.initd
    zabbix-server.confd
    zabbix_server.conf.patch
    zabbix-custom-rootfs-support-3.2.3.patch
"

_builddir="$srcdir"/zabbix-$pkgver

# security fixes:
#   3.0.4-r0:
#   - CVE N/A ZBX-11023

prepare() {
    cd "$_builddir"
    # update_config_sub || return 1
    for i in $source; do
        case $i in
        *eglibc*.patch)
            if [ "$CLIBC" == "eglibc" ]; then
                msg "Applying $i"
                patch -p1 -i "$srcdir"/$i || return 1
            fi
            ;;
        *.patch)
            msg "Applying $i"
            patch -p1 -i "$srcdir"/$i || return 1
            ;;
        esac
    done
    aclocal -I m4 && autoconf && autoheader \
        && automake --add-missing || return 1
    # update_config_sub
    # Fix config file locations
    sed -i "$_builddir"/conf/zabbix_server.conf \
        -e 's|SNMPTrapperFile=/tmp|SNMPTrapperFile=/var/log/zabbix|' \
        -e 's|PidFile=/tmp|PidFile=/var/run/zabbix|' \
        -e 's|LogFile=/tmp|LogFile=/var/log/zabbix|' || return 1
}

build() {
    _configure="--prefix=/usr \
        --sysconfdir=/etc/zabbix \
        --mandir=/usr/share/man \
        --infodir=/usr/share/info \
        --enable-ipv6 \
        --with-net-snmp \
        --with-libcurl \
        --with-libxml2 \
        --with-openipmi \
        --with-unixodbc \
        --with-ssh2 \
        --with-gnutls"

    cd "$_builddir"
    ./configure \
        --enable-server \
        --with-sqlite3 \
        --build=$CBUILD \
        --host=$CHOST \
        $_configure \
        || return 1
    make || return 1
}

package() {
    install -d -m0750 -o zabbix -g zabbix \
        "$pkgdir"/var/run/zabbix "$pkgdir"/var/log/zabbix
    install -D -m0644 "$_builddir"/conf/zabbix_server.conf \
        "$pkgdir"/etc/zabbix/zabbix_server.conf
    install -D -m0755 "$srcdir"/zabbix-server.initd \
        "$pkgdir"/etc/init.d/zabbix-server || return 1
    install -D -m0644 "$srcdir"/zabbix-server.confd \
        "$pkgdir"/etc/conf.d/zabbix-server || return 1
    mkdir -p "$pkgdir"/usr/sbin || return 1
    mv "$_builddir"/src/zabbix_server/zabbix_server \
        "$pkgdir"/usr/sbin/ || return 1
    mkdir -p "$pkgdir"/usr/share/zabbix/database || return 1
    mv "$_builddir"/database/sqlite3 \
        "$pkgdir"/usr/share/zabbix/database/ || return 1
    cd "$_builddir"
    for i in upgrades/dbpatches/*/sqlite3; do
        [ -e $i ] || continue
        mkdir -p "$pkgdir"/usr/share/zabbix/${i%/*}
        mv "$i" "$pkgdir"/usr/share/zabbix/$i
    done
}

md5sums="b058115f9218b085310cd07bbbeb9cd0  zabbix-3.2.3.tar.gz
3a71e310bd2b38498a7c6830169f7480  zabbix-getloadavg.patch
bf62c539870874e11de39c60cb974786  automake.patch
40c81bdec85815f4ba637eb6528cc5e8  musl-fix-includes.patch
5db990fcb9eff6177c60884e24f95982  zabbix-server.initd
bd91d0243cf8f72b86b9bf0b91963663  zabbix-server.confd
3d031903ea14e1de0804ff1230fd968e  zabbix_server.conf.patch
e0602556506e94ae4e94f9677d7593d3  zabbix-custom-rootfs-support-3.2.3.patch"
sha256sums="e6dba74039d8d6efff86ec3da99909f4daeaeb66d48781bbb666e3094533da25  zabbix-3.2.3.tar.gz
d2c0651c5fa67a1857707552e79ecece7ca95c149042460c40456634bf7611dc  zabbix-getloadavg.patch
b347ca77660e69bea353c50e2fce0c7c4cc837f782c9f84f74ba92c1a62b4c1b  automake.patch
38b4e1a5d5c16c7d9b31347acf710d84b693f6e1df365d1072548e897e034884  musl-fix-includes.patch
52ada7d1906abd9a05823acd466f43a7b177f4763c07d45670fd202f8b913748  zabbix-server.initd
ddf75041fb0afc5b211dd79a934341cc9db4325447ad33a42cbf09bdfb5cad42  zabbix-server.confd
f87b221d32b3088db78c013f11d035339d7058817092dfdcc39898b4b3ee8448  zabbix_server.conf.patch
e211f367b9bf29115105faeaf723a49e5295ec938ee15b2308e19ad9d2f94c09  zabbix-custom-rootfs-support-3.2.3.patch"
sha512sums="5a704282765fa66d1aa53ae546d3a49a35050d6830a25a3a9ad64d73f8aff48b31e8d13f37d147c8d6244bb0f2dab21bceb5d022f1c3ffa726c10edc6e7bd1f6  zabbix-3.2.3.tar.gz
b65c6ba7701d98ae7f6fe2124c1d2b8b8fea3c3cc7ee080bf99f5afff0aaa6a025c2a1f5136b4700b53d1b7609e6185642650d7edd013c554b2af37fddae771c  zabbix-getloadavg.patch
9bff8966cb8b3f1767bfb1b3f3529bca5c9957f2c8179a40ded3b4e43615ba9fb408aef43092fd119b7df80b042555d05c9780fac3760176b95524aa48252fee  automake.patch
9b87ec1ea4a9cbb501c16012d498cdae82a696f4cd495e1e8cb201d9e31c6e135da5bb264c6273f2de87297bd3e4bd16f66703610686f5d610e3316ee24aac91  musl-fix-includes.patch
6bb7a0d679473248ceb547ee652ec4a7d0c42947e05f1fded7380c8c34accffefe224e2a607fc190ad12dafb57da14d75becbf060b04aed9ccc8adbc5ff2e836  zabbix-server.initd
a91821c6086a1fc0197750cc68073419defcb7d775b11b14a993409a8f61c7a1a0a0af95de27eed9f3b8357f8362640cb1b26b91b56f4f1d714ca6f222d02b80  zabbix-server.confd
e0c9f937d39e15fa34e70e8ae9e6578b221b51c13dc0515e807675d153a85ab6370ed20ce2d06aa4457baaf3963edce525cd00e85fb105b36b58741798d13836  zabbix_server.conf.patch
27f9611259616ab5ae61ba3ff405c21a2fb8fd5937f93388476c587ab6d36e969d9d657099ae3a6b9406467ea0017ac4b6aa81221fbed2bb0dcc5e37db231659  zabbix-custom-rootfs-support-3.2.3.patch"
